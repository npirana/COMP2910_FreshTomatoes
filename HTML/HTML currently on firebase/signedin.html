<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Fresh Tomatoes</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.ccssom/css?family=Lato" rel="stylesheet" type="text/css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.13.0/firebase.js"></script>
                <script src="https://www.gstatic.com/firebasejs/4.13.0/firebase-firestore.js"></script>
        <script>
            var config = {
                apiKey: "AIzaSyC2Kd411Dg8EZk6q_w1p4AvGfuCLHJk45w",
                authDomain: "freshtomatoes-4171e.firebaseapp.com",
                databaseURL: "https://freshtomatoes-4171e.firebaseio.com",
                projectId: "freshtomatoes-4171e",
                storageBucket: "freshtomatoes-4171e.appspot.com",
                messagingSenderId: "554706711397"
            };
            firebase.initializeApp(config);
            db = firebase.firestore();
            const firestore = firebase.firestore();
            const settings = {timestampsInSnapshots: true};
            firestore.settings(settings);
        </script>
        <link rel="stylesheet" href="css/Style2.css">
    </head>
    <body id="myPage">
        <div class="div1">
            <p id="welcomeBoi">Welcome to Fresh Tomatoes</p>
        </div>
        <div id="div2" class="jumbotron text-center">
            <div id="signDiv">
                <img id="avatar" alt="Avatar" height="80" src="http://cdn.onlinewebfonts.com/svg/img_264157.png">

                <p id="namep">You're signed in as <span id="name"></span></p>
            </div>
        </div>
        <div id="div3" class="container-fluid">
            <div class="row">
                <div>
                    <p class="text-center">Fresh Tomatoes was created by COMP 2910 students in an effort to reduce food wastage.</p> 
                </div>

            </div>
        </div>
        <div class="div3"></div>
    </body>

    <script>
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                // User is signed in.
                var displayName = user.displayName;
                var email = user.email;
                var emailVerified = user.emailVerified;
                var photoURL = user.photoURL;
                var isAnonymous = user.isAnonymous;
                var uid = user.uid;
                var providerData = user.providerData;
                document.getElementById("avatar").setAttribute("src", photoURL);
                span = document.getElementById("name");
                txt = document.createTextNode(displayName);
                span.appendChild(txt);




                var userCol = db.collection("users").doc(uid);
                userCol.get().then(function (userDat) {
                    if (userDat.exists) {
                        console.log("User exists, redirecting to app");
                        setTimeout("location.href = 'shoplist.html';",500);
                    } else {
                        console.log("User does not exist, trying to create user");
                        userCol.set({
                            lastThreeLists: "placeholder"

                        }).then(function() {
                            console.log("User doc created");
                            var firstList = userCol.collection("lists");
                            firstList.add({
                                itemCount: 0,
                                itemIndex: {
                                }
                            }).then(function(firstListRef){
                                var firstListUID = firstListRef.id;
                                console.log("1st item list created. Ref: ", firstListUID);
                                console.log("Trying to set lastThreeLists.")
                                userCol.set({
                                    lastThreeLists: {
                                        "list1": firstListUID,
                                        "list2": "placeholder",
                                        "list3": "placeholder"
                                    }
                                }).then(function(){
                                    console.log("lastThreeLists set");
                                    setTimeout("location.href = 'getstarted.html';",100);
                                }).catch(function(error2){
                                    console.log("Error setting lastThreeLists: ", error2);
                                });

                            }).catch(function(error1){
                                console.log("Error creating 1st list: ", error1);
                            });
                        }).catch(function(error){
                            console.log("Error creating user: ", error);
                        });

                        

                    }
                }).catch(function(error) {
                    console.log("Error getting doc: ", error);
                });






                // ...
            } else {
                console.log("Not logged in")
                // User is signed out.
                // ...
                location.href = 'index.html';
            }
        });
    </script>
</html>